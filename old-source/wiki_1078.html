Recovering STM32VL-DISCOVERY board for use with Linux
2013-11-10 01:31:01
RussellSenior

<p>This is a method I used for reprogramming the programmer chip, an STM32F103C8T6, on an STM32VL-DISCOVERY board, to make the board more useful under Linux.&nbsp; I had two boards that had been reflashed several years ago with a <a href="http://www.versaloon.com/">Versaloon</a> firmware, which was originally written for an external programming device that used the same programmer chip.&nbsp; Instructions for using OpenOCD and single-wire debug (SWD) with this combination did not work out-of-the-box with modern OpenOCD.&nbsp; When I queried residents of the #openocd IRC channel, they suggested trying the <a href="http://www.blacksphere.co.nz/main/blackmagic">Black Magic Probe</a> software instead.&nbsp; That's what I did.&nbsp; These instructions are almost wholely derived from other instructions found online.&nbsp; All credit is due to them, all errors (please correct them!) are mine.</p><p>Source material:</p><ul><li>This talks about putting Versaloon on the board from 2.5+ years ago: http://takenapart.com/?p=82</li><li>This gives some sometimes ambiguous directions for a slightly different board, which can be confusing to follow: http://embdev.net/articles/STM_Discovery_as_Black_Magic_Probe</li><li>The ST Micro resource page for the board: http://www.st.com/web/catalog/tools/FM116/SC959/SS1532/LN1199/PF250863</li><li>The board schematics: http://www.st.com/st-web-ui/static/active/en/resource/technical/layouts_and_diagrams/schematic_pack/stm32vldiscovery_sch.zip (particularly MB913.pdf)</li></ul><ol><li>The first problem is that the F103 chip does not connect its SWD pins to any easily accessible headers.&nbsp; It is therefore necessary to make a temporary hardware modification to get access to them.&nbsp; Here are "before" and "after" pictures (using a cell phone camera through a 10x stereo-dissecting microscope) of the attachments.&nbsp; The blue wire is connected to SWCLK (left side of SB6); the yellow wire is connected to SWDIO (left side of SB10).&nbsp; Don't let the solder bridges actually bridge.<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <img alt="Solder bridges before" src="http://iris.personaltelco.net/~russell/stm32vl-discovery-photos/IMG_20131109_214703.jpg" style="width: 388px; height: 518px;"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <img alt="Solder bridges before" src="http://iris.personaltelco.net/~russell/stm32vl-discovery-photos/IMG_20131109_215919.jpg" style="width: 388px; height: 518px;"></p></li><li>Obtain a cross compiling toolchain.&nbsp; I used the one from <a href="https://launchpad.net/gcc-arm-embedded">GCC ARM Embedded</a>.&nbsp; In particular, I used the pre-built binaries from the Ubuntu PPA repository after I encountered a minor problem building my own toolchain from upstream sources.&nbsp; Call me lazy, but they worked.</li><li>Clone the Black Magic Probe software from github and build for STLink:<ul><li><strong>cd ~/src/</strong></li><li><strong>git clone git://github.com/gsmcmullin/blackmagic.git</strong></li><li><strong>cd blackmagic</strong></li><li><strong>git submodule init</strong></li><li><strong>git submodule update</strong></li><li><strong>cd libopencm3</strong></li><li><strong>make</strong></li><li><strong>cd ..</strong></li><li><strong>make PROBE_HOST=stlink</strong></li></ul></li><li>Now, you need an already-working single-wire debugger to program the programmer chip.&nbsp; If you have an existing STLink/v2 device, like an STM32F3-DISCOVERY or STM32F4-DISCOVERY board, or an ST-LINK/V2 dongle, then you are set.&nbsp; For any STLink/v2 device, you can use the texane stlink software.&nbsp; I used an ST-LINK/V2 dongle, but the others should work about the same.&nbsp; Clone and build the software, if needed:<ul><li><strong>cd ~/src</strong></li><li><strong>git clone git://github.com/texane/stlink.git</strong></li><li><strong>cd stlink</strong></li><li><strong>./autogen.sh</strong></li><li><strong>./configure</strong></li><li><strong>make</strong></li></ul></li><li>Wire up pins:<ul><li>Ground</li><li>SWCLK</li><li>SWDIO</li><li>Target VCC (optional?) ... I hooked this to the 5V pin following my upstream sources, and that worked</li></ul></li><li>Try out st-util, to see if you are talking to something:<ul><li>$ <strong>~/src/stlink/st-util -v</strong><br>2013-11-10T00:38:54 INFO src/stlink-common.c: Loading device parameters....<br>2013-11-10T00:38:54 INFO src/stlink-common.c: Device connected is: F1 Medium-density device, id 0x20036410<br>2013-11-10T00:38:54 INFO src/stlink-common.c: SRAM size: 0x5000 bytes (20 KiB), Flash: 0x10000 bytes (64 KiB) in pages of 1024 bytes<br>Chip ID is 00000410, Core ID is&nbsp; 1ba01477.<br>Target voltage is 4642 mV.<br>Listening at *:4242...</li><li>&lt;ctrl-C&gt;</li></ul></li><li>Grab a copy of the existing flash image and look at the hexdump (the "Versaloon" string is pretty clear evidence we are talking to the right part, since Versaloon isn't likely to be anywhere else on the board):<ul><li>$ <strong>~/src/stlink/st-flash read /tmp/orig.bin 0x8000000</strong><br>2013-11-10T00:47:42 INFO src/stlink-common.c: Loading device parameters....<br>2013-11-10T00:47:42 INFO src/stlink-common.c: Device connected is: F1 Medium-density device, id 0x20036410<br>2013-11-10T00:47:42 INFO src/stlink-common.c: SRAM size: 0x5000 bytes (20 KiB), Flash: 0x10000 bytes (64 KiB) in pages of 1024 bytes<br>$ hexdump -C /tmp/orig.bin | tail<br>00004b00&nbsp; b9 30 00 08 bb 30 00 08&nbsp; c1 31 00 08 21 31 00 08&nbsp; |.0...0...1..!1..|<br>00004b10&nbsp; b5 31 00 08 a9 31 00 08&nbsp; 89 31 00 08 00 00 00 00&nbsp; |.1...1...1......|<br>00004b20&nbsp; 08 00 00 00 05 01 00 00&nbsp; 15 1a 00 08 81 30 00 08&nbsp; |.............0..|<br>00004b30&nbsp; 15 1a 00 08 15 1a 00 08&nbsp; 15 1a 00 08 a5 30 00 08&nbsp; |.............0..|<br>00004b40&nbsp; 15 1a 00 08 15 1a 00 08&nbsp; 99 30 00 08 01 01 00 00&nbsp; |.........0......|<br>00004b50&nbsp; a4 49 00 08 56 65 72 73&nbsp; 61 6c 6f 6f 6e 28 30 78&nbsp; |.I..Versaloon(0x|<br>00004b60&nbsp; 33 33 29 62 79 20 53 69&nbsp; 6d 6f 6e 28 63 6f 6d 70&nbsp; |33)by Simon(comp|<br>00004b70&nbsp; 69 6c 65 64 20 6f 6e 20&nbsp; 4a 61 6e 20 31 32 20 32&nbsp; |iled on Jan 12 2|<br>00004b80&nbsp; 30 31 31 29 00 00 00 00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |011)....|<br>00004b88</li></ul></li><li>Now, program the F103 with the Black Magic software you built earlier.&nbsp; There are two parts, the blackmagic_dfu.bin (bootloader) and blackmagic.bin.&nbsp; The blackmagic_dfu.bin gets written at 0x8000000, and blackmagic.bin gets written at 0x8002000.&nbsp; Once the bootloader part is on there, you have other options for flashing the blackmagic.bin payload, but hells-bells, you've got the programmer connected, you might as well use it!<ul><li>$ <strong>~/src/stlink/st-flash erase</strong><br>2013-11-10T00:55:13 INFO src/stlink-common.c: Loading device parameters....<br>2013-11-10T00:55:13 INFO src/stlink-common.c: Device connected is: F1 Medium-density device, id 0x20036410<br>2013-11-10T00:55:13 INFO src/stlink-common.c: SRAM size: 0x5000 bytes (20 KiB), Flash: 0x10000 bytes (64 KiB) in pages of 1024 bytes<br>Mass erasing<br>$ <strong>~/src/stlink/st-flash write ~/src/blackmagic/src/blackmagic_dfu.bin 0x8000000</strong><br>2013-11-10T00:56:20 INFO src/stlink-common.c: Loading device parameters....<br>2013-11-10T00:56:20 INFO src/stlink-common.c: Device connected is: F1 Medium-density device, id 0x20036410<br>2013-11-10T00:56:20 INFO src/stlink-common.c: SRAM size: 0x5000 bytes (20 KiB), Flash: 0x10000 bytes (64 KiB) in pages of 1024 bytes<br>2013-11-10T00:56:20 INFO src/stlink-common.c: Attempting to write 6720 (0x1a40) bytes to stm32 address: 134217728 (0x8000000)<br>Flash page at addr: 0x08001800 erased<br>2013-11-10T00:56:21 INFO src/stlink-common.c: Finished erasing 7 pages of 1024 (0x400) bytes<br>2013-11-10T00:56:21 INFO src/stlink-common.c: Starting Flash write for VL/F0 core id<br>2013-11-10T00:56:21 INFO src/stlink-common.c: Successfully loaded flash loader in sram<br>&nbsp; 6/6 pages written<br>2013-11-10T00:56:21 INFO src/stlink-common.c: Starting verification of write complete<br>2013-11-10T00:56:21 INFO src/stlink-common.c: Flash written and verified! jolly good!<br>$ <strong>~/src/stlink/st-flash write ~/src/blackmagic/src/blackmagic.bin 0x8002000</strong><br>2013-11-10T00:57:35 INFO src/stlink-common.c: Loading device parameters....<br>2013-11-10T00:57:35 INFO src/stlink-common.c: Device connected is: F1 Medium-density device, id 0x20036410<br>2013-11-10T00:57:35 INFO src/stlink-common.c: SRAM size: 0x5000 bytes (20 KiB), Flash: 0x10000 bytes (64 KiB) in pages of 1024 bytes<br>2013-11-10T00:57:35 INFO src/stlink-common.c: Attempting to write 51144 (0xc7c8) bytes to stm32 address: 134225920 (0x8002000)<br>Flash page at addr: 0x0800e400 erased<br>2013-11-10T00:57:37 INFO src/stlink-common.c: Finished erasing 50 pages of 1024 (0x400) bytes<br>2013-11-10T00:57:37 INFO src/stlink-common.c: Starting Flash write for VL/F0 core id<br>2013-11-10T00:57:37 INFO src/stlink-common.c: Successfully loaded flash loader in sram<br>&nbsp;49/49 pages written<br>2013-11-10T00:57:41 INFO src/stlink-common.c: Starting verification of write complete<br>2013-11-10T00:57:42 INFO src/stlink-common.c: Flash written and verified! jolly good!</li></ul></li><li>Disconnect the SWD programmer from the board, and disconnect/reconnect, you should see something like this in dmesg:<ul><li>[443492.652066] usb 2-2: new full-speed USB device number 37 using uhci_hcd<br>[443492.833056] usb 2-2: New USB device found, idVendor=1d50, idProduct=6018<br>[443492.833062] usb 2-2: New USB device strings: Mfr=1, Product=2, SerialNumber=3<br>[443492.833065] usb 2-2: Product: Black Magic Probe (STLINK), (Firmware 1.5-00215-g42570ef, build 20131110)<br>[443492.833069] usb 2-2: Manufacturer: Black Sphere Technologies<br>[443492.833071] usb 2-2: SerialNumber: BDD396D7<br>[443492.839100] cdc_acm 2-2:1.0: This device cannot do calls on its own. It is not a modem.<br>[443492.839134] cdc_acm 2-2:1.0: ttyACM1: USB ACM device<br>[443492.843105] cdc_acm 2-2:1.2: This device cannot do calls on its own. It is not a modem.<br>[443492.843141] cdc_acm 2-2:1.2: ttyACM2: USB ACM device</li></ul></li><li>Now, start your cross-gdb (note, previously I was getting /dev/ttyACM0 and /dev/ttyACM1; the first one listed in dmesg is the one to use for gdb, so /dev/ttyACM1 here... pay attention!):<ul><li>$ <strong>arm-none-eabi-gdb</strong></li><li>GNU gdb (GNU Tools for ARM Embedded Processors) 7.4.1.20130913-cvs<br>Copyright (C) 2012 Free Software Foundation, Inc.<br>License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;<br>This is free software: you are free to change and redistribute it.<br>There is NO WARRANTY, to the extent permitted by law.&nbsp; Type "show copying"<br>and "show warranty" for details.<br>This GDB was configured as "--host=i686-pc-linux-gnu --target=arm-none-eabi".<br>For bug reporting instructions, please see:<br>&lt;http://www.gnu.org/software/gdb/bugs/&gt;.<br>(gdb) <strong>target extended-remote /dev/ttyACM1</strong><br>Remote debugging using /dev/ttyACM1<br>(gdb) <strong>mon swdp_scan</strong><br>Target voltage: unknown<br>Available Targets:<br>No. Att Driver<br>&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STM32, Medium density.<br>(gdb) <strong>attach 1</strong><br>Attached to Remote target<br>0x080001b6 in ?? ()</li></ul></li><li>To program the main CPU, the STM32F100RBT6B, just "load" your .elf file!<ul><li>(gdb) <strong>load ~/src/stm32/an3268/stm32vldiscovery_package/Project/Examples/GPIOToggle/GPIOToggle.elf</strong><br>Loading section .isr_vector, size 0x1d0 lma 0x8000000<br>Loading section .text, size 0xfa4 lma 0x80001d0<br>Loading section .data, size 0x34 lma 0x8001174<br>Start address 0x8001101, load size 4520<br>Transfer rate: 14 KB/sec, 645 bytes/write.<br>(gdb) <strong>file ~/src/stm32/an3268/stm32vldiscovery_package/Project/Examples/GPIOToggle/GPIOToggle.elf</strong><br>A program is being debugged already.<br>Are you sure you want to change the file? (y or n) <strong>y</strong><br>Reading symbols from /home/russell/src/stm32/an3268/stm32vldiscovery_package/Project/Examples/GPIOToggle/GPIOToggle.elf...done.<br>(gdb) <strong>run</strong><br>The program being debugged has been started already.<br>Start it from the beginning? (y or n) <strong>y</strong><br>Starting program: /home/russell/src/stm32/an3268/stm32vldiscovery_package/Project/Examples/GPIOToggle/GPIOToggle.elf</li></ul></li><li>Celebrate by desoldering the wires you so carefully tacked down on the solder bridge pads back at step 1.&nbsp; You can flash an updated blackmagic.bin using the bootloader code.&nbsp; You enter the bootloader by holding the black reset (RST) button as you plug in the USB cable.&nbsp; Check dmesg, you should see something like this, note "(Upgrade)":<ul><li>[445094.960058] usb 2-2: new full-speed USB device number 44 using uhci_hcd<br>[445095.193080] usb 2-2: New USB device found, idVendor=1d50, idProduct=6017<br>[445095.193087] usb 2-2: New USB device strings: Mfr=1, Product=2, SerialNumber=3<br>[445095.193090] usb 2-2: Product: Black Magic (Upgrade) for STLink/Discovery, (Firmware 1.5-00215-g42570ef, build 20131110)<br>[445095.193094] usb 2-2: Manufacturer: Black Sphere Technologies<br>[445095.193096] usb 2-2: SerialNumber: BDD396D7</li></ul></li><li>In the "Upgrade" mode, you can update blackmagic.bin using dfu-utils from git://gitorious.org/dfu-util/dfu-util.git<ul><li>$ <strong>cd ~/src</strong></li><li>$ <strong>git clone git://gitorious.org/dfu-util/dfu-util.git</strong></li><li>$ <strong>cd dfu-util</strong></li><li>$ <strong>./autogen.sh</strong></li><li>$ <strong>./configure</strong></li><li>$ <strong>make</strong></li><li>You need to add a dfu suffix to the file, so do that, maybe to a copy:</li><li>$ <strong>cp ~/src/blackmagic/src/blackmagic.bin /tmp/blackmagic.bin</strong></li><li>$ <strong>~src/dfu-util/src/dfu-suffix -a /tmp/blackmagic.bin</strong></li><li>dfu-suffix (dfu-util) 0.7<br><br>(C) 2011-2012 Stefan Schmidt<br>This program is Free Software and has ABSOLUTELY NO WARRANTY<br>Please report bugs to dfu-util@lists.gnumonks.org<br><br>Suffix successfully added to file<br>$ <strong>sudo ~/src/dfu-util/src/dfu-util -v -D /tmp/blackmagic.bin</strong><br>dfu-util 0.7<br><br>Copyright 2005-2008 Weston Schmidt, Harald Welte and OpenMoko Inc.<br>Copyright 2010-2012 Tormod Volden and Stefan Schmidt<br>This program is Free Software and has ABSOLUTELY NO WARRANTY<br>Please report bugs to dfu-util@lists.gnumonks.org<br><br>DFU suffix version 100<br>Opening DFU capable USB device...<br>ID 1d50:6017<br>Run-time device DFU version 011a<br>Claiming USB DFU Interface...<br>Setting Alternate Setting #0 ...<br>Determining device status: state = dfuIDLE, status = 0<br>dfuIDLE, continuing<br>DFU mode device DFU version 011a<br>Device returned transfer size 1024<br>DfuSe interface name: "Internal Flash&nbsp;&nbsp; "<br>Memory segment at 0x08000000&nbsp;&nbsp; 8 x 1024 =&nbsp; 8192 (r)<br>Memory segment at 0x08002000&nbsp; 56 x 1024 = 57344 (rew)<br>dfu-util: Only DfuSe file version 1.1a is supported</li></ul></li><li>Celebrate!</li></ol><p>&nbsp;</p><p>&nbsp;</p>