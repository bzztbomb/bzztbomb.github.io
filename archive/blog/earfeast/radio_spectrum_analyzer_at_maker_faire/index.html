<p>[<i>This post is <a href="http://www.sharebrained.com/2013/05/21/maker-faire-radio-spectrum-analyzer/">originally from my blog</a>. I'm bringing this spectrum analyzer to <a href="http://hak5.org/videolog/portland-meetup-may-25">Darren Kitchen's Hak5 event at OMSI</a> this Saturday (2013/05/25).</i>]</p><p>Here's some details of my radio spectrum analyzer hack at Maker Faire. But first, a quick video of the hack in action:</p><p><iframe allowfullscreen="" frameborder="0" height="315" src="http://www.youtube.com/embed/rmVu_mw3aJU" width="560"></iframe></p><h2>Technical Details</h2><p>This project is built around the <a href="http://greatscottgadgets.com/hackrf/">HackRF</a>, a software-defined radio transciever. I programmed it to sample 20MHz of radio spectrum from an antenna, do a frequency analysis on the data, and display the results on a Noritake vacuum fluorescent display. I added the tuning wheel mid-afternoon on Sunday, and it really improved the interactivity of the display. It felt really cool to spin the wheel around and watch the spectrum scroll back and forth. Too bad I didn't capture that in the video...</p><p><a href="http://www.sharebrained.com/wp-content/2013/05/radio-spectrum-analyzer1-e1369184474197.jpg"><img alt="" class="aligncenter size-medium wp-image-1009" height="560" src="http://www.sharebrained.com/wp-content/2013/05/radio-spectrum-analyzer1-e1369184474197-420x560.jpg" title="Radio Spectrum Analyzer at Maker Faire 2013" width="420"></a></p><p>The HackRF's microcontroller is an <a href="http://www.nxp.com/products/microcontrollers/cortex_m4/LPC4330FBD144.html">ARM Cortex-M4F + Cortex-M0 "dual core" chip</a>. Both are running at 204MHz. The M4F has hardware floating point, which drastically simplifies the signal processing code.</p><p>The ARM grabs 512 complex samples at a time from the radio analog-to-digital converter (ADC). It applies a <a href="http://en.wikipedia.org/wiki/Window_function">window function</a> that reduces artifacts from sampling arbitrary chunks of a radio signal. The windowed samples are converted to <a href="http://en.wikipedia.org/wiki/Frequency_domain">frequency domain</a> data through a 512-point <a href="http://en.wikipedia.org/wiki/Fft">fast-Fourier transform (FFT)</a>. The frequency data that comes out of the FFT (frequency vs. a <a href="http://en.wikipedia.org/wiki/Complex_numbers">complex</a> vector) is converted to real magnitudes. I take the <a href="http://en.wikipedia.org/wiki/Logarithm">logarithm</a> of each magnitude to get values vs. frequency that resemble <a href="http://en.wikipedia.org/wiki/Decibel">decibels</a>. Then, I scale the log-magnitude data to fit nicely on the <a href="http://noritake-vfd.com/gu384x32l-3900.aspx">vacuum fluorescent display</a>, which is 384 x 32 pixels. For each frequency in the scaled data, I render a bar into a frame buffer I maintain in RAM, using cute bit-shifting tricks. Then, I render marks at 1MHz intervals to provide a tick-mark scale on the display. In the left corner of the display, I render minimum and maximum sample buffer values for each of the two sampling channels -- this is so I can tell if I need to turn up or down the gain on the receiver. I draw the current tuning frequency in MHz at the center of the display. Lastly, I scan out each of the pixels, one byte at a time, into the VFD's parallel 8-bit interface, using the display's "Graphic DMA" mode.</p><p>The optical <a href="http://en.wikipedia.org/wiki/Rotary_encoder#Single-track_Gray_encoding">quadrature encoder</a> runs purely on interrupts. Whenever a positive- or negative-going edge is detected on either of the two optical sensors, an interrupt is generated. Based on the current and previous values of the optical sensors, the software (borrowed from <a href="http://www.pjrc.com/teensy/td_libs_Encoder.html">PJRC's Encoder Library</a>) decides if the wheel has moved, and if so, which way it has moved. Based on that decision, the tuning frequency is incremented or decremented.</p><p>There was a hairy bit of wiring between the HackRF and the VFD. I needed to interface the HackRF, which is a 3.3 Volt device, to the VFD, which communicates at 5 Volts. So I needed to translate several signals between those two voltages. I had an old circuit board from my <a href="https://github.com/sharebrained/robotron-fpga">Robotron-FPGA project</a> that did exactly that, for a completely different purpose. But with enough wires and headers and disgusting rewiring, I made it work. But it wasn't pretty. I had to keep poking it and twisting it, as some signals were intermittent and sometimes needed my help.</p><h2>The Faire Experience</h2><p>The HackRF can tune from below 10MHz (where it's mostly amateur radio and AM radio stations), up through 6GHz. That includes *almost* every signal in common use. Until I added the tuning dial, I left the HackRF at about 840MHz, right in the middle of one of the cellular (mobile phone) bands. As you'd imagine, lots of cellular phones were in use at Maker Faire, so a lot of signals were jumping about on the display. People who really got the display would soon pull out their phones to make a call. Most of the time, their phones were operating in other cellular bands, but a few times we got lucky and could clearly see activity that came and went depending on whether they were in a call or not.</p><p>Late Saturday, a couple of <a href="http://en.wikipedia.org/wiki/Amateur_radio_operator">hams (amateur radio operators)</a> came by with their portable radio transcievers. I tuned the HackRF up to 440MHz and we could see peaks when they were transmitting. They were amused...</p><p>The first half of Sunday, I attached the optical encoder wheel and wired up the optical interrupters to the HackRF. The wheel was laser cut acrylic, cut before I left for Maker Faire. I cut a bunch of different designs, since I wasn't sure exactly how everything would fit together ahead of time. The wheel was mounted on a <a href="http://en.wikipedia.org/wiki/Lazy_Susan">Lazy Susan</a> apparatus I bought at a hardware store. I drilled the wheel assembly to my display whiteboard, and then started attaching the optical interruptors with hot glue. Unfortunately, I needed a couple of 470 Ohm through-hole resistors to control the current through the interruptors' LEDs, but I didn't bring *any* resistors with me. So I went begging at the Radio Shack "Learn to Solder" tent, and they were kind enough to bust open one of their $60 electronics kits to give me $0.07 worth of resistors. While I was gone, somebody had forcefully cranked the wheel and broken off several of the teeth. I should've seen that coming! Fortunately, I had lots of other options from my laser cutting binge. I settled on a sandwich, consisting of the tooth pattern cut in paper with clear thin plastic on either side.</p><p>Once I got the encoder software working, I added a frequency display in the middle of the VFD. People would walk up and give the wheel a spin, looking around for interesting signals. There's a lot of underutilized spectrum (at least where we were), so it wasn't too exciting outside the cellular and 2.4GHz bands. The environment was also quite electrically noisy, so with a fairly insensitive receiver, long-distance bands (e.g. aviation) didn't really show anything -- those weaker signals were jammed by all the motors and <a href="http://blog.makezine.com/2013/05/19/arcattacks-steve-ward-demos-the-handheld-tesla-coil/">Tesla coils</a> nearby. I'm sure my antenna also wasn't the best...</p><p>Despite the last-minute additions and general hackiness of the project, I had a lot of fun building it and talking with people about it. Events like Maker Faire are great as a reminder that you're not the only person in the world who likes to nerd out on such obscure things!</p>
