RFM69 Wireless & SPI Bus Sharing (feedback wanted...)
2014-07-27 11:19:04
paul

<p>Recently I've been working to improve the Arduino SPI library, to better support multiple SPI devices with different settings, and SPI devices requiring interrupts.</p><p>Today I discovered a new problem while testing the HopeRF RFM69 wireless module.</p><p><img alt="" src="http://www.dorkbotpdx.org/files/images/rfm69_1.jpg" style="width: 720px; height: 298px;"></p><p>Click "Read more" for details and the workaround I found....</p><p><!--break--></p><p>First, this article is meant to publically document what I've found and invite conversation with anyone else who might have experienced similar issues.&nbsp; It's very difficult to know if this problem is caused by buggy software, faulty hardware, or radio interference.&nbsp; Please comment below, or on <a href="http://forum.pjrc.com/threads/25897-Adapter-board-RFM69W-radio-for-Teensy-3-Also-diagnostic-software">this forum thread</a>, if you have any insight or opinions.</p><p>In a nutshell, I've been working on new Arduino SPI library functions to allow SPI devices with different settings and usage of attachInterrupt, where the interrupt routine uses SPI.transfer(), to hopefully work together.&nbsp; With the SPI library from Arduino 1.0.5 &amp; 1.5.7, usage from within an interrupt routine can occur while the main program is using SPI.transfer with another device's chip select active, and of course each device might need very different SPI settings.</p><p>As part of this testing, I've been working with the Ethernet library using a WIZ820io module and the RadioHead library with a RFM69W wireless module.&nbsp; The Ethernet library used with Teensy has a patch to allow either W5100 or W5200 chips, so the normally unsupported WIZ820io works fine.&nbsp; In my testing, I've patched both libraries to use the new SPI.beginTransaction() and SPI.endTransaction() functions, and RadioHead uses SPI.usingInterrupt(), to let those 2 functions know which interrupt needs to be masked while the Ethernet library is using SPI.</p><p>So a caveat is that I've working with 3 patched libraries.&nbsp; There's a lot of uncertainty here.</p><p>My test program uses a Teensy 3.1 to send a request to another board running RadioHead's "rf69_server" example, and also a HTTP request to fetch a web page.&nbsp; Then it tries to receive both of them.&nbsp; I'll attach the code below.</p><p>The RFM69 is unable to receive while the Ethernet library polls the WIZ820io.&nbsp; I spent hours carefully checking the waveforms on my oscilloscope.&nbsp; At first I thought this must be a bug in my code.&nbsp; But it's easy to see the 2 chip selects never assert simultaeously, as they might if SPI.beginTransaction didn't mask the interrupt while Ethetnet uses SPI.&nbsp; It's easy to see the other device is sending the reply, because its LED blinks when it transmits on its RFM69.&nbsp; They're sitting right next to each other on my desk (the first photo) and with a line uncommented in the code to cause the Ethernet polling to wait 20 ms, the radio reply is always received correctly.</p><p>Finally, in an act of desparation, I build this little hack to force the SCK signal low at the RFM69 when its NSS chip select is idle (high).</p><p><img alt="" src="http://www.dorkbotpdx.org/files/images/rfm69_2.jpg" style="width: 720px; height: 487px;"></p><p>Amazingly, this works!&nbsp; It allows the RFM69 to receive, while the Ethenet module is polling.</p><p>I'm still not ready to conclude the RFM69 has a hardware bug, where activity at the SCK input, which ought to be ignored while NSS is high, might be causing it to miss incoming radio data.</p><p>It's entirely possible the communication could be creating radio interference.&nbsp; My <a href="https://www.oshpark.com/shared_projects/RIumMBtN">little adaptor board</a> has a ground plane between the RFM69 and the digital signals (I'm a little paranoid of messing up RF stuff).</p><p>It's also possible my software has a bug, even though the waveforms appear to be fine on a scope.&nbsp; I might have missed something.</p><p>Anyway, here's a quick schematic for that little circuit.</p><p><img alt="" src="http://www.dorkbotpdx.org/files/images/rfm69_3.jpg" style="width: 480px; height: 573px;"></p><p>I also created a <a href="https://www.oshpark.com/shared_projects/fArfKEaE">new adaptor board</a> with this circuit.</p><p><img alt="" src="http://www.dorkbotpdx.org/files/images/rfm69_4.jpg" style="width: 425px; height: 135px;"></p><p>Here are my patched copies of these libraries:</p><p><a href="https://github.com/PaulStoffregen/SPI">https://github.com/PaulStoffregen/SPI</a></p><p><a href="https://github.com/PaulStoffregen/Ethernet">https://github.com/PaulStoffregen/Ethernet</a></p><p><a href="https://github.com/PaulStoffregen/RadioHead">https://github.com/PaulStoffregen/RadioHead</a></p><p>At this point, the big question is whether I've made a mistake somewhere (entirely likely), or if the RFM69 module really has some sort of issue where SPI bus usage by other devices, with the RFM69's NSS signal high, causes trouble with radio reception?</p><p>If you've used the RFM69 or similar HopeRF modules on a SPI bus with a lot of other activity, please reply or <a href="http://forum.pjrc.com/threads/25897-Adapter-board-RFM69W-radio-for-Teensy-3-Also-diagnostic-software">comment on the forum thread</a>.&nbsp; I'd really like to hear about your experiences.</p>