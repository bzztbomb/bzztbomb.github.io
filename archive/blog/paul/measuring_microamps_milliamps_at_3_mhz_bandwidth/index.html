<p>Recently I needed to actually "see" a current waveform in the 100 uA to 5 mA range with at least a couple MHz bandwidth.&nbsp; <a href="http://www.home.agilent.com/en/pd-2229629-pn-N2820A/3-mhz-50ua-high-sensitivity-ac-dc-current-probe-2-ch">This extremely expensive probe</a> would have been perfect, but instead I built something similar for about $30 using the amazing Analog Devices <a href="http://www.analog.com/en/specialty-amplifiers/instrumentation-amplifiers/ad8428/products/product.html">AD8428</a> amplifier.</p><p><img alt="" src="http://www.dorkbotpdx.org/files/images/current1.jpg" style="width: 640px; height: 374px;"></p><p>Click "Read more" for details and a scope screenshot....</p><p><!--break--></p><p>The first step was cutting the power trace and adding a resistor.&nbsp; I used two 1 ohm resistors in parallel.</p><p><img alt="" src="http://www.dorkbotpdx.org/files/images/current2.jpg" style="width: 640px; height: 550px;"></p><p>At 5 mA, this makes only 2.5 mV.&nbsp; My scope's supposed resolution is 1 mV, but the truth is there's plenty of noise down in the 1 mV range.&nbsp; That's pretty common for most scopes, even pretty spendy ones.&nbsp; So it's just not feasible to measure this signal directly (not to mention using 2 probes and subtracting them in the scope).</p><p>That incredibly expensive Agilent probe probably has a couple really nice amplifiers inside.... so I went searching for an amplifier.&nbsp; After a bit of seaching, I found the AD8428.&nbsp; It has a fixed gain of 2000 and a bandwidth of 3.5 MHz.&nbsp; That's a gain-bandwidth product of 7 GHz !!!&nbsp; It's also an extremely well matched instrumentation amp with an amazimg CMRR of 140 dB.&nbsp; So it gets rid of the power supply voltage and outputs the amplified signal referenced to ground.</p><p>The AD8428 is perfect.&nbsp; It's so very easy!&nbsp; Of course, such amazing performance costs money: about $20.&nbsp; Here's that expensive little amplifier, and a 5V to +/- 15V power supply (about $10) to power it.</p><p><img alt="" src="http://www.dorkbotpdx.org/files/images/current3.jpg" style="width: 640px; height: 424px;"></p><p>The one trick with measuring such tiny voltages is twisting the 2 sense wires together.&nbsp; Honestly, I didn't try it running them separately, but since this thing is getting voltages in only the microvoltage range for the lower measurements, I didn't want to risk picking up noise.&nbsp; I also put a 100 ohm resistor on the output, just in case I accidentally short the output or do something clumsy that migth blow that little $20 part.</p><p>Here's a scope screenshot using this little amplifier to "see" the current (the blue waveform).</p><p><img alt="" src="http://www.dorkbotpdx.org/files/images/current_scope.png" style="width: 800px; height: 548px;"></p><p>In this test, the microcontroller is running in its slowest mode at only 10 kHz, drawing about 120 uA.&nbsp; Then when the chip's internal oscillator is started, the current jumps to about 600 uA.&nbsp; Later, the CPU switches to actually clocking from that oscillator.&nbsp; There's an on-chip clock divider which is switched in and increased gradually.</p><p>The bottom trace (red) is the voltage on the chip's 1.8V linear regulator.&nbsp; It turns out that sudden jumps in current cause pretty substantial downward spikes on the regulated voltage.&nbsp; This more gradual startup approach really helps.&nbsp; This sort of thing is impossible to see with a slow multimeter, but with a reasonably good bandwidth measurement of the current, it's easy to see what various code actually does to the current.</p><p>I tried connecting my multimeter to the amp output.&nbsp; Sometimes it's just a lot more convenient to look at a single number on a meter than fiddle with the scope.&nbsp; I had been using the current mode on the meter before building this.&nbsp; One thing I was surprised to find it my little meter updates its screen much faster while measureing about 125 mA than it does when measuring 125 uA.</p><p>Another interesting thing I've been noticing is patterns within the blue current waveform.&nbsp; This Agilent scope has a "digital phosphor" rendering of the huge amount of data it collected.&nbsp; This static screenshot can't really capture the interactive experience of adjusting the waveform intensity, where various regions within the data change brightness differently, indicating there's something interesting/different going on.&nbsp; Even so, you can see several areas in the screenshot where interesting things are happening once the CPU is up and running.&nbsp; It's interesting how the current waveform changes as different code executes.</p><p>I know this isn't anything terribly impressive... basically just buy a high-end amplifier and use it with a series resistor.&nbsp; Maybe it even reads like an Analog Devices ad?&nbsp; I'm not affiliated with Analog Devices... I just bought this part at normal qty 1 pricing from Digikey.</p><p>Still, this is the first time I've ever really looked at such low microcontroller currents with a few MHz bandwidth, and I'm guessing not many people have ever bothered to really measure such currents, so I thought I'd share.</p><p>&nbsp;</p><p>&nbsp;</p>
