Audio clip player
2013-08-11 15:36:45
paul

<p>Yesterday I made a little audio clip player for a Monty Python Flying Circus theme party.&nbsp; It plays the 3 second dramatic sound for the unexpected <a href="http://www.youtube.com/watch?v=Tym0MObFpTI">Spanish Inquisition</a> entrance.</p><p><img alt="" src="http://www.dorkbotpdx.org/files/images/nobody_expects_the.jpg" style="width: 640px; height: 576px;"></p><p>Click "Read more" for the schematic, source code and sound file....</p><p><!--break--></p><p>The hardware is pretty simple.&nbsp; It's just a Teensy 3.0 that "plays" the audio using a PWM pin.</p><p>The PWM is amplified to a 9V signal using a NPN transistor, then a pair of transistors buffer the signal to the current required to drive an 8 ohm speaker.</p><p>I had intended to make a nice L-C filter to remove the PWM carrier, but only the 100 uH inductor made it onto the breadboard as I quickly put this thing together in only a couple hours.</p><p><img alt="" src="http://www.dorkbotpdx.org/files/images/sch.jpg" style="width: 720px; height: 308px;"></p><p>The source code is extremely simple.&nbsp; Teensy 3.0 has the <a href="http://www.pjrc.com/teensy/td_pulse.html">ability to configure its PWM frequency</a>, so it's set to 187.5 kHz.</p><p>The audio is played by just reading each byte from a big array and updating the PWM with analogWrite(), repeating every 32 microseconds until all the data is played.</p><p>Two little chunks of code slowly ramp the PWM from zero to 0x80 (the "center" where zero is for the audio) before playing and back down again afterward, so there isn't a pop sound.</p>
<pre>#include&nbsp;<span style="color: #006699;">"spanish_inquisition.h"</span>

<span style="color: #CC6600;">void</span> <span style="color: #CC6600;"><b>setup</b></span>()
{
	<span style="color: #CC6600;">unsigned</span> <span style="color: #CC6600;">int</span> i;
	<span style="color: #CC6600;">elapsedMicros</span> usec;

	<span style="color: #CC6600;">analogWriteFrequency</span>(3, 187500);
	<span style="color: #CC6600;">analogWriteResolution</span>(8);
&nbsp;	<span style="color: #7E7E7E;">// gracefully ramp up from 0 to 0x80 (dc bias)</span>
	<span style="color: #CC6600;">for</span> (i=0; i &lt; 0x80; i++) {
		<span style="color: #CC6600;">analogWrite</span>(3, i);
		<span style="color: #CC6600;">while</span> (usec &lt; 120) ; <span style="color: #7E7E7E;">// wait</span>
		usec&nbsp;=&nbsp;usec&nbsp;-&nbsp;120;
	}
	<span style="color: #7E7E7E;">// play the audio data</span>
	usec&nbsp;=&nbsp;0;
	<span style="color: #CC6600;">for</span> (i=0; i &lt; sizeof(file_spanish_inquisition); i++) {
		<span style="color: #CC6600;">analogWrite</span>(3, (file_spanish_inquisition[i] + 0x80) &amp; 255);
		<span style="color: #CC6600;">while</span> (usec &lt; 32) ; <span style="color: #7E7E7E;">// wait</span>
		usec&nbsp;=&nbsp;usec&nbsp;-&nbsp;32;
	}
&nbsp;	<span style="color: #7E7E7E;">// gracefully ramp down 0x80 (dc bias) to zero</span>
	<span style="color: #CC6600;">for</span> (i=0x80; i &gt; 0; i++) {
		<span style="color: #CC6600;">analogWrite</span>(3, i);
		<span style="color: #CC6600;">while</span> (usec &lt; 120) ; <span style="color: #7E7E7E;">// wait</span>
		usec&nbsp;=&nbsp;usec&nbsp;-&nbsp;120;
	}
	<span style="color: #CC6600;">pinMode</span>(3, <span style="color: #006699;">OUTPUT</span>);
	<span style="color: #CC6600;">digitalWrite</span>(3, <span style="color: #006699;">LOW</span>);
	<span style="color: #7E7E7E;">// todo: enter lowest power shutdown mode</span>
}

<span style="color: #CC6600;">void</span> <span style="color: #CC6600;"><b>loop</b></span>()
{
}

</pre>
<p>The final part, which of course I did first, is the audio.&nbsp; I just used <a href="https://addons.mozilla.org/en-US/firefox/addon/video-downloadhelper/">DownloadHelper</a> to save the YouTube video.&nbsp; Then I opened the .mp4 file with <a href="http://audacity.sourceforge.net/">Audacity</a>, to clip out only the 3.2 seconds for the entract sound.&nbsp; I also used the low pass filter to filter everything above 10 kHz (it still sounds fine with 10 kHz bandwidth), and I applied some gain to the point of a tiny bit of clipping, so it would use the full range of the PWM.</p><p>Converting to the header file used by the code above was actually a 3 step process.&nbsp; After Audacity, <a href="http://sox.sourceforge.net/">sox</a> is used to convert to 31250 sample rate and 8 bit raw data.&nbsp; Then a perl script reads the raw data and creates the header file.&nbsp; I've included all those parts in the zip file below.</p><p>At the party last night, I brought 3 cheap red robes (searched Amazon for red robe and sorted by price, lowest first!) and 3 toy costume crosses (Robin found them at a craft store).&nbsp; A friend brought a red hat and 2 soft cushions.&nbsp; Much silly fun was had.</p><p>&nbsp;</p>