<p>For the last several days I've been working to compile the latest free GNU Toolchain for ARM published by CodeSourcery (now owned by Mentor Graphics).</p><p>This process has not been easy.&nbsp; In this lengthy blog post, I'll share all the patches I've written, with detailed explanations of exactly what errors I encountered, what I've learned about each problem, and how to work around it.</p><p>Edit: <a href="https://github.com/PaulStoffregen/ARM-Toolchain">full source is on github</a>.</p><p>"Read mode" for all the gory details......</p><p><!--break--></p><h2><strong>Why CodeSourcery's GNU Toolchain?</strong></h2><p>You might be wondering why CodeSourcery's version of the toolchain, rather than the official GNU sources.&nbsp; The simple answer is CodeSourcery is the primary contributor of ARM support for microcontrollers.&nbsp; Their code contains the best support for the latest ARM microcontrollers.&nbsp; They publish only 2 binaries, Windows and 32 bit Linux.&nbsp; If you want 64 bit Linux and Mac version (as I do), you need to compile your own.</p><p>&nbsp;</p><h2><strong>Mentor's Build Script</strong></h2><p>As required by the open source licenses, they publish the full source.&nbsp; They also publish a huge script with the exact commands they used to build the toolchain.&nbsp; The script comes with this comment:</p><p style="margin-left: 40px;"><code># This file contains the complete sequence of commands<br># Mentor Graphics used to build this version of Sourcery CodeBench.<br>#<br># For each free or open-source component of Sourcery CodeBench,<br># the source code provided includes all of the configuration<br># scripts and makefiles for that component, including any and<br># all modifications made by Mentor Graphics.&nbsp; From this list of<br># commands, you can see every configuration option used by<br># Mentor Graphics during the build process.<br>#<br># This file is provided as a guideline for users who wish to<br># modify and rebuild a free or open-source component of<br># Sourcery CodeBench from source. For a number of reasons,<br># though, you may not be able to successfully run this script<br># directly on your system. Certain aspects of the Mentor Graphics<br># build environment (such as directory names) are included in<br># these commands. Mentor Graphics uses Canadian cross compilers so<br># you may need to modify various configuration options and paths<br># if you are building natively. This sequence of commands<br># includes those used to build proprietary components of<br># Sourcery CodeBench for which source code is not provided.<br>#<br># Please note that Sourcery CodeBench support covers only your<br># use of the original, validated binaries provided as part of<br># Sourcery CodeBench -- and specifically does not cover either<br># the process of rebuilding a component or the use of any<br># binaries you may build.&nbsp; In addition, if you rebuild any<br># component, you must not use the --with-pkgversion and<br># --with-bugurl configuration options that embed Mentor Graphics<br># trademarks in the resulting binary; see the "Mentor Graphics<br># Trademarks" section in the Sourcery CodeBench Software<br># License Agreement.</code></p><p>Indeed, the script is very useful as a guideline, but using it directly is pretty much impossible.&nbsp;&nbsp; The script is obviously generated by another script, which isn't provided.&nbsp; Everywhere, very long and specific full path names are embedded.&nbsp; Custom versions of gcc, which aren't provided, are used by the script.&nbsp; Those Mentor trademarks are also embedded in many places.&nbsp; There's several sections compiling the proprietary components, which need to be removed.&nbsp; You can read the script, but it's easier to write a new one than trying to run the one Mentor provides.</p><p>It took me any entire day's work to deconstruct this giant script.&nbsp; The most time consuming part was learning the purpose of each pathname.&nbsp; All the tools are configured with prefix set to "/opt/codesourcery".&nbsp; However, the script never actually uses that directory.&nbsp; The actual toolchain is installed to "/scratch/jbrown/arm-eabi/install", using an incredible amount of tedious work on every "make install" to override all the defaults based on prefix.&nbsp; For quite some time, the word "scratch" confused me about the real purpose of that directory.&nbsp; Lots of other stuff that actually is scratch (or temporary stuff) goes into "/scratch/jbrown/arm-eabi/obj" and similar directories.&nbsp; For example, static libraries are built into "/scratch/jbrown/arm-eabi/obj/pkg-2012.09-63-arm-none-eabi/arm-2012.09-63-arm-none-eabi.extras/host-libs-i686-pc-linux-gnu/usr".&nbsp; Making sense of all these directories is the key.&nbsp; Then it's merely an extremely long build script....</p><p>After a couple days, I managed to recreate the entire script in a format similar to the widely used "summon arm toolchain" script.&nbsp; For compiling the Linux version on Ubuntu 12.04, I was able to resolve pretty much every problem in my script by just looking at exactly what options CodeSourcery used.</p><p>&nbsp;</p><h2><strong>GMP Check Problems</strong></h2><p>Of course, the first person I shared the binary with could not use it.&nbsp; His system was an older version of Fedora, which had an older version of the libc.&nbsp; So I used a virtual machine with Ubuntu 10.04 to compile the code.&nbsp; That's where the problems began!</p><p>The first error was in GMP, the GNU Multiple Precision Arithmetic library.&nbsp; All recent version of gcc use this library.&nbsp; After you compile the library, it prints this helpful message.</p><p style="margin-left: 40px;"><code>+-------------------------------------------------------------+<br>| CAUTION:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>| If you have not already run "make check", then we strongly&nbsp; |<br>| recommend you do so.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>| GMP has been carefully tested by its authors, but compilers |<br>| are all too often released with serious bugs.&nbsp; GMP tends to |<br>| explore interesting corners in compilers and has hit bugs&nbsp;&nbsp; |<br>| on quite a few occasions.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>+-------------------------------------------------------------+</code></p><p>Of course, I included a "make check" in my script.&nbsp; It ran without any error in Ubuntu 12.04, but failed with these errors on 10.4 in the virtual machine:</p><p style="margin-left: 40px;"><code>mpz_inp_str nread wrong<br>&nbsp; inp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "0"<br>&nbsp; base&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 10<br>&nbsp; pre&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br>&nbsp; post&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1<br>&nbsp; got_nread&nbsp;&nbsp; 0<br>&nbsp; want_nread&nbsp; 1<br>/bin/bash: line 5: 10113 Aborted&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ${dir}$tst<br>FAIL: t-inp_str<br>.........................<br>t-io_raw.c:102: GNU MP assertion failed: ! ferror(fp)<br>/bin/bash: line 5: 10223 Aborted&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ${dir}$tst<br>FAIL: t-io_raw<br>.........................<br>======================================================================================<br>2 of 59 tests failed<br>Please report to gmp-bugs@gmplib.org, see http://gmplib.org/manual/Reporting-Bugs.html<br>======================================================================================</code></p><p>Searching for the text of these errors turns up lots of web pages and email list conversations, with no useful answers.&nbsp; That's why I'm writing this blog post, with the actual messages and explanation about what causes them and how to work around them.... so hopefully anyone hitting these errors will (hopefully) find this info.</p><p>At first, not finding any info about bugs in GMP or workarounds for these issues, I concluded it must be some bug in the compiler that was present in Ubuntu 10.04 but fixed by 12.04.&nbsp; I installed another virtual machine with 10.10, with the same result.&nbsp; Then 11.04, and then 11.11.&nbsp; It seemed the problem must have been fixed between 11.11 and 12.04, since 12.04 running on my machine produced no errors.&nbsp; For the sake of completeness (and also because I'd been up all night installing virtual machines, to the point Robin was about to wake up soon), I kept going to tried 12.04 in a virtual machine.</p><p>Ubuntu 12.04 failed GMP's "make check" inside VirtualBox, but passed the same check running natively!&nbsp; Then I tried running those 2 specific test programs manually.&nbsp; The copy compiled inside VirtualBox passes when run natively, but fails when run within the virtual machine.</p><p>Again, I searched on google, trying dozens of different queries with fragments of the error messages, virtualbox, ubuntu 12.04 and many, many other seemingly relevant terms.&nbsp; It's a reoccurring theme of GNU toolchain compile errors.... searching for pretty much any error always turns up at least a few people asking for help with that exact error message, but rarely is there ever any useful reply (in fact, most have no reply at all).</p><p>So I started digging into the t-io_raw.c and t-inp_str.c code, adding lots of printf() statements and looking at the test files they write with a hex editor.&nbsp; It turned out, the file was indeed longer than it should have been when running inside virtualbox vs running natively.&nbsp; Adding "truncate" to more google searches finally led to VirtualBox bug #9485.</p><p>https://www.virtualbox.org/ticket/9485<br>https://forums.virtualbox.org/viewtopic.php?f=3&amp;t=44056<br><br>Indeed, the GMP tests use fopen(filename, "w+") to truncate the file back to zero bytes, before writing new test data.&nbsp; Knowing this was the problem, I added remove(filename) in front of each fopen(filename, "w+).&nbsp; There were several more places this occurs in the GMP tests.&nbsp; See my patches attached at the end of this message for the full solution.</p><p>&nbsp;</p><h2><strong>More VirtualBox Trouble</strong></h2><p>Unfortunately, another ugly VirtualBox bug stopped the build process.&nbsp; At least this one was easy to figure out.&nbsp; Here's the error:</p><p style="margin-left: 40px;"><code>The directory that should contain system headers does not exist:<br>&nbsp; /home/paul/teensy/arm_compile/arm-none-eabi/arm-none-eabi/usr/include</code></p><p>The previous steps did indeed build and install the libraries.&nbsp; But the "usr" part of that pathname is apparently required by something inside GCC's build process.&nbsp; Mentor's script (and mine by the way of copying Mentor's steps) creates a symbolic link before the final gcc build, so it will find the library headers.</p><p>When I looked at the files, the symbolic link simply wasn't there!</p><p>It turns out, this is another VirtualBox bug, number 10085:</p><p>https://www.virtualbox.org/ticket/10085#comment:14</p><p>Apparently when using shared folders, when you create a symbolic link, the link can point to locations on the host's filesystem which the guest in the virtual machine should not be able to access, because they may be outside the shared folder.&nbsp; Obviously the VirtualBox people never thought carefully about how to implement symbolic links.&nbsp; When it was reported as a security vulnerability, they just disabled it.</p><p>Fortunately, you can reenable symbolic links in shared folders using VBoxManage.</p><pre class="wiki">VBoxManage setextradata VM_NAME VBoxInternal2/SharedFoldersEnableSymlinksCreate/SHARE_NAME 1</pre><p>Obviously, substiture the machine name and share name for VM_NAME and SHARE_NAME.</p><p>This episode has really shaken my confidence in VirtualBox.&nbsp; Many years ago, before VirtualBox, I purchased VMware Workstation (I believe it was version 2 or 3).&nbsp; Sadly, VMware doesn't update their kernel driver, unless you pay for expensive upgrages.&nbsp; Other people updated the driver, but it became quite a chose to constantly search for unofficial kernel sources.&nbsp; When VirtualBox came along, I dumped my ancient VMware... even though that very old version greatly outperformed VirtualBox.</p><p>If anyone from VMware reads this, I'm seriously considering buying Workstation again.&nbsp; Really, it's not the cost that concerns me, but rather it breaking every time Ubuntu publishes a kernel update.&nbsp; I had such a painful experience, long-term, with that old version of Workstation constantly breaking with each kernel update.&nbsp; I depend upon being able to compile and test code in virtual machines... and usually it's an urgent need like a customer has a problem I need to reproduce.&nbsp; I depend on the shared folders to quickly access code and files.</p><p>I really need to find a more reliable and dependable virtual machine....</p><p>&nbsp;</p><h2><strong>CLOOG Library on Mac OS-X</strong></h2><p>With Linux working (and my script implementing everything Mentor did), I turned to compiling for Macintosh.&nbsp; I was relieved when GMP passed, but this problem compiling CLOOG quickly turned up:</p><p style="margin-left: 40px;"><code>ld: library not found for -lgcc_s</code></p><p>As usual, searching for the error and combinations of related terms finds pages with the same problem (or at least similar errors), but no solutions.</p><p>However, I did find this page, which references a makefile written by James Snyder.</p><p>http://gnuarmeclipse.livius.net/wiki/Toolchain_installation_on_OS_X</p><p>James obviously deconstructed Mentor huge build script and created a nice makefile.&nbsp; However, it's for an older version of the tools, before the CLOOG library was used.&nbsp; James did use a small patch to run bash instead of sh.&nbsp; Apparently something in gcc's multilib build depends upon bash.&nbsp; I used James's patch, and it's included in the set attached to this post.</p><p>Thanks James!&nbsp; :-)</p><p>For CLOOG, It didn't take much digging to find the libgcc_s.a is named slightly differently by Apple.</p><p>It turns out, CLOOG's configure script has a check for compiling on OS-X, to use the correct name, but it doesn't work because it checks for a specific (and old) version.&nbsp; Here's the code:</p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LIBS="$LIBS -lppl_c -lppl -lgmpxx -lstdc++"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if test x$host_alias = xi686-darwin8; then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LIBS="$LIBS -lgcc_s.10.4"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; elif test x$host_alias != xi686-mingw32; then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LIBS="$LIBS -lgcc_s"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fi</code></p><p>On my late-2011 MacBook running Lion (10.7) and Xcode command line tools 4.5.2, host is "x86_64-apple-darwin11.4.2", not "i686-darwin8".&nbsp; I actually created a much more general patch, which is included in the file attached to the blog post.</p><h2>&nbsp;</h2><h2><strong>Another GMP Check Issue - Windows</strong></h2><p>I've always felt a little <span class="vk_ans vk_dgy">intimidated</span> by Canadian cross compiling, which means compiling a compiler that will run on another system, producing code for yet a 3rd system.&nbsp; The GNU toolchain calls "build" the system you're using the build the tools, "host" the system where those tools will run, and "target" the system that will execute the compiler's output.&nbsp; But standing on the CodeSourcery giant's shoulder (or at least their giant example script), I decided to give Canadian cross compiling a try.</p><p>Right away, I ran into another GMP check failure.</p><p style="margin-left: 40px;"><code>t-scanf.c:1497: GNU MP assertion failed: ret == (-1)<br><br>abnormal program termination<br>FAIL: t-scanf.exe</code></p><p>Having learned from the VirtualBox problems, I copied the executable to an actual Windows machine.&nbsp; Sure enough, it runs without error on real Windows, but fails in Wine.</p><p>For this one, spending time trying google searches actually paid off!&nbsp; I found this message from Rick Jones at RedHat, which explains the problem and provides a patch.</p><p>http://gmplib.org/list-archives/gmp-devel/2009-January/000817.html</p><p>This patch is included in the archive attached to this blog post.</p><p>&nbsp;</p><h2><strong>MAKE for Windows</strong></h2><p>I decided to try building GNU make for Windows and Mac, since Microsoft and Apple don't provide it with their base system.</p><p style="margin-left: 40px;"><code>glob.c:76:18: error: pwd.h: No such file or directory<br>glob.c: In function ‘glob’:<br>glob.c:681: warning: assignment makes pointer from integer without a cast<br>glob.c:684: error: dereferencing pointer to incomplete type<br>glob.c:765: warning: assignment makes pointer from integer without a cast<br>glob.c:768: error: dereferencing pointer to incomplete type<br>make[2]: *** [glob.o] Error 1</code></p><p>I spent quite a lot of time searching for this error with related keywords.&nbsp; I found a few threads, and one gave a solution for the first error (adding a #ifdef check for __MINGW32__).</p><p>http://lists.gnu.org/archive/html/make-w32/2003-04/msg00006.html</p><p>I started digging through the code, finding all the places with WINDOWS32 and adding the check for __MINGW32__.&nbsp; Then I grepped the files in other directories and found many more WINDOWS32 checks.&nbsp; I knew this wasn't a good path, so I started looking at why WINDOWS32 wasn't being defined for my cross compile.</p><p>Inside make's configure script, mingw is checked like this:</p><p style="margin-left: 40px;"><code>case "$host" in<br>&nbsp; *-*-mingw32) </code></p><p>The mingw cross compiler I'm using is the package from Ubuntu, which has host string "i586-mingw32msvc", that doesn't match this check (only 1 dash character).&nbsp; A simple patch to allow make's configure to recognized Ubuntu's mingw magically made everything work!</p><p>&nbsp;</p><h2><strong>GCC, MinGW and caddr_t</strong></h2><p>The next problem was in compiling gcc.&nbsp; There's something disheartening about gcc compile errors.&nbsp; Any error is bad enough.&nbsp; Even a relatively small package like GMP has hundreds of source files, but gcc.....</p><p>In fact, I had to scroll up the window and sift through many lines just to see the error.&nbsp; At this point, gcc's build appears to be nested at least 4 or 5 makefiles deep!&nbsp; Here's the actual error:</p><p style="margin-left: 40px;"><code>In file included from /home/paul/arm/native/bin/../lib/gcc/arm-none-eabi/4.7.2/../../../../arm-none-eabi/include/stdio.h:46:0,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from /home/paul/arm/workdir/gcc-4.7-2012.09/libgcc/../gcc/tsystem.h:88,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from /home/paul/arm/workdir/gcc-4.7-2012.09/libgcc/crtstuff.c:62:<br>/home/paul/arm/native/bin/../lib/gcc/arm-none-eabi/4.7.2/../../../../arm-none-eabi/include/sys/types.h:126:16: error: expected identifier or '(' before 'char'</code></p><p>The actual code at line 126 in types.h was this:</p><p><code>typedef char *&nbsp; caddr_t;</code></p><p>I spent quite a bit of time trying to understand how something so simple could be an unexpected identifier before "char".&nbsp; How could "typedef" be an unexpected identifier.</p><p>Searching on google, using lots of different combinations of keywords, turned up numerous people encountering similar problems, but few useful leads.&nbsp; Ultimately I ended up grepping all the gcc files for "caddr_t" until I found this suspicious code in gcc/configure:</p><p style="margin-left: 40px;"><code>ac_fn_c_check_type "$LINENO" "caddr_t" "ac_cv_type_caddr_t" "$ac_includes_default"<br>if test "x$ac_cv_type_caddr_t" = x""yes; then :<br><br>else<br><br>cat &gt;&gt;confdefs.h &lt;&lt;_ACEOF<br>#define caddr_t char *<br>_ACEOF<br><br>fi</code><br>&nbsp;</p><p>Indeed, that was turning the perfectly reasonable "<code>typedef char * caddr_t" into </code>"<code>typedef char * char *"</code>.&nbsp; Not good.</p><p>Also not good is why.&nbsp; Some investigating shows the check runs the mingw compiler to learn if its headers define caddr_t.&nbsp; If the code doesn't compile, then the #define is added to confdefs.h.&nbsp; That's great for compiling gcc itself.&nbsp; But clearn confdefs.h is being intermingled with newlib's headers.&nbsp; I don't know if this is a bug in gcc, or just somehow I haven't probably specified build, host and target (I did pass them all and much more to the top-level configure).</p><p>Anyway, the solution (or ugly hack) was just to comment out that #define line.&nbsp; It's in my patch collection attached to this post.<br>&nbsp;</p><h2><strong>Multilib Problems</strong></h2><p>With all these tweaks, the toolchain compiles on every platform.&nbsp; But it produces non-working programs!</p><p>However, the same LED blink test program did work with CodeSourcery's published binary copy.&nbsp; So I used arm-none-eabi-objdump -d to disassemble each one, and then I manually compared their generated assembly language code.</p><p>It turned out my build was including 32 bit ARM instructions for certain library functions, not the 16/32 bit Thumb2 instructions that CodeSourcery was properly including.&nbsp; They had configured multilib differently.</p><p>This command prints a summary of the compiler's multilib setup.</p><p style="margin-left: 40px;">arm-none-eabi-gcc -dumpspecs | grep -A1 multilib:</p><p>If you get what looks like a correct compiler, but non-working programs, maybe this will help?</p><p>After much digging, I tracked the problem down to the file "t-cs-eabi-lite", which is used due to the configure option "--enable-extra-sgxxlite-multilibs".&nbsp; I'm not 100% of the cause of the error, but it seems like perhaps the file provided might not actually be the same as what they used when compiling their toolchain?</p><p>Anyway, since I'm building a toolchain targeting only 1 board, I just hacked this file up horribly to target only the hardware I need.&nbsp; My t-cs-eabe-lite file is in the archive, but I was warn you not to use it, unless you intend to build a limited toolchain.&nbsp; Perhaps I'll revisit this file (or maybe someone will leave a comment with improvements).&nbsp; At least this message might help you get to the cause of wrong architecture code being linked, rather than go through so much trouble to successfully compile and only have the resulting output not work.</p><p>&nbsp;</p><h2><strong>Contacting Me... "Thanks", not "Tech Support"</strong></h2><p>I took several hours to write this lengthy blog post, recreating each problem in each environment to get the exact errors, so you dear reader might have better luck with google, or whatever search you use, to find these solutions.&nbsp; Throughout this project, finding others with the same errors has been easy, but solutions seem rare.&nbsp; Hopefully this blog post will help a bit?</p><p>Also, it's meant to give fellow Dorkbotters (in the unlikely case they have time read this) a glimpse into this process and what I've been up to.&nbsp; Perhaps it might help me too, if I later need to figure out why I created these patches.</p><p>I'm pretty easy to find if you search for Paul Stoffregen.&nbsp; Please, if you do contact me, say "thanks".&nbsp; DO NOT ask me for technical support with the GNU toolchain, particularly compiling it.&nbsp; If it doesn't compile or doesn't work, and you can't find the answer online (pretty much my experience for most errors), you're going to have to dig into the code and figure it out yourself.&nbsp; Hopefully this message might give you some insight.</p><p>The several hours I've spent composing this message are as much as I can help you with GNU toolchain compile issues.</p><p>&nbsp;</p>
